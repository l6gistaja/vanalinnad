<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
		<html xmlns="http://www.w3.org/1999/xhtml>"
		  <head>
		    <title>Vanalinnad</title>
		    <meta http-equiv='imagetoolbar' content='no'/>
        <style type="text/css">
            html, body, #map {
                margin: 0;
                width: 100%;
                height: 100%;
            }
        </style>

		    <script src="lib/OpenLayers-2.13.1/OpenLayers.js"></script>
		    <script type="text/javascript">
		        var map;
			    var mapBounds = new OpenLayers.Bounds( 24.60708, 59.3364170921, 24.9646964904, 59.54061);
//24.60034, 59.3318136554, 24.9692732994, 59.54286);
			    var mapMinZoom = 12;
			    var mapMaxZoom = 15;

		        // avoid pink tiles
		        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
		        OpenLayers.Util.onImageLoadErrorColor = "transparent";

                      var areaDir = 'Tallinn/';
                      var confXml;

function getXmlValue(xmlDocument, tagname) {
  return xmlDocument.getElementsByTagName(tagname)[0].childNodes[0].nodeValue;
}

function init(){
  function xmlHandlerConf(request) {
    if(request.status == 200) {
      document.getElementById('map').innerHTML = '';
      confXml = request.responseXML;
      initAfterConf();
    }
  }
  OpenLayers.Request.GET({ url: "conf.xml", callback: xmlHandlerConf });
}

function initAfterConf(){
	            var options = {
	                //controls: [],
	                projection: new OpenLayers.Projection("EPSG:900913"),
	                displayProjection: new OpenLayers.Projection("EPSG:4326"),
	                units: "m",
	                //maxResolution: 156543.0339,
	                //maxExtent: new OpenLayers.Bounds(-20037508, -20037508, 20037508, 20037508.34)
		            };
	            map = new OpenLayers.Map('map', options);



                function osm_getTileURL(bounds) {
                    var res = osm.map.getResolution();
                    var x = Math.round((bounds.left - osm.maxExtent.left) / (res * osm.tileSize.w));
                    var y = Math.round((osm.maxExtent.top - bounds.top) / (res * osm.tileSize.h));
                    var z = osm.map.getZoom();
                    var limit = Math.pow(2, z);

                    if (y < 0 || y >= limit) {
                        return getXmlValue(confXml, 'dirraster') + getXmlValue(confXml, 'filetransparent');
                    } else {
                        x = ((x % limit) + limit) % limit;
                        return osm.url + z + "/" + x + "/" + y + "." + osm.type;
                    }
                }
        
                function overlay_getTileURL(bounds) {
                    var res = this.map.getResolution();
                    var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
                    var y = Math.round((bounds.bottom - this.tileOrigin.lat) / (res * this.tileSize.h));
                    var z = this.map.getZoom();
                    if (this.map.baseLayer.name == 'Virtual Earth Roads' || this.map.baseLayer.name == 'Virtual Earth Aerial' || this.map.baseLayer.name == 'Virtual Earth Hybrid') {
                       z = z + 1;
                    }
                       if (mapBounds.intersectsBounds( bounds ) && z >= mapMinZoom && z <= mapMaxZoom ) {
                       return getXmlValue(confXml, 'dirraster')
                                + getXmlValue(confXml, 'dirplaces')
                                + areaDir + '1968/'
                                + getXmlValue(confXml, 'dirtiles')
                                + z + "/" + x + "/" + y + "." + this.type;
                } else {
                   return osm_getTileURL(bounds);
                   //return getXmlValue(confXml, 'dirraster') + getXmlValue(confXml, 'filetransparent');
                }
                }
	            // create OSM/OAM layer
                    currentTime = new Date();
	            var osm = new OpenLayers.Layer.TMS( currentTime.getFullYear(),
	                "http://tile.openstreetmap.org/",
	                {
                          type: 'png',
                          getURL: osm_getTileURL,
                          displayOutsideMaxExtent: true,
                          attribution: '',
                          isBaseLayer: true
                        } );

	            // create TMS Overlay layer
	            var tmsoverlay = new OpenLayers.Layer.TMS( "1968", "",
	                {
                          type: 'jpg',
                          getURL: overlay_getTileURL,
                          alpha: false,
                          isBaseLayer: true
	                });



//24.782855189778953 , 59.4397431226174
//24.785312594059988 , 59.43867739587352
//minx="59.33712609243092" miny="24.60199999999999" maxx="59.54199999999995" maxy="24.96500918950904"
//SN 0.204
//WE 0.3631
//var c = [24.78588, 59.43851, 0.1815, 0.1035];
//var c = [24.78588, 59.43851, 0.1788, 0.1021];
x = 0.00000799;
var c = [24.76042843550409, 59.43317554493973, x*7943,x*5995];
//grbbox = new OpenLayers.Bounds(24.6019, 59.33712609243092, 24.96500918950904, 59.54199999999995);
grbbox = new OpenLayers.Bounds(c[0]-c[2], c[1]-c[3], c[0]+c[2], c[1]+c[3]);
//alert((c[0]-c[2])+', '+(c[1]-c[3])+', '+(c[0]+c[2])+', '+(c[1]+c[3]));
            var graphic = new OpenLayers.Layer.Image(
                'tln',
                //'cache/1968crop_legendless.jpg',
                'cache/1957_blanked.jpg',
                grbbox.transform(map.displayProjection, map.projection ),
                //new OpenLayers.Size(9820,11150),
                new OpenLayers.Size(7943,5995),
                {numZoomLevels: 15}
            );

	            map.addLayers([
osm,

//graphic,
                      
                      tmsoverlay,

                    ]);
/**/



    function createPopup(feature) {
      feature.popup = new OpenLayers.Popup.Anchored("streetPopup",
          map.getCenter(),
          null,
          feature.attributes.name,
          null,
          true,
          function() { kmlLayersCtl.unselectAll(); }
      );
      feature.popup.setBorder('solid 2px black');
      feature.popup.autoSize = true;
      map.addPopup(feature.popup);
    }

    function destroyPopup(feature) {
      feature.popup.destroy();
      feature.popup = null;
    }

    var kmlLayers = [];
    for(i=0; i<5; i++) {
      kmlLayers[i] = new OpenLayers.Layer.Vector("Roads "+(1+i), {
            projection: new OpenLayers.Projection("EPSG:4326"),
            maxResolution: map.getResolutionForZoom(10+i),
            strategies: [new OpenLayers.Strategy.Fixed()],
            protocol: new OpenLayers.Protocol.HTTP({
                url: getXmlValue(confXml, 'dirvector')
                      + getXmlValue(confXml, 'dirplaces')
                      + areaDir 
                      + getXmlValue(confXml, 'fileprefixroads') + i + ".kml",
                format: new OpenLayers.Format.KML({
                    extractAttributes: true,
                    maxDepth: 0
                })
            }),
          styleMap: new OpenLayers.StyleMap({
            'default': new OpenLayers.Style({'strokeWidth': 3,'strokeColor': '#ff0000'}),
            'select': new OpenLayers.Style({'strokeWidth': 5,'strokeColor': '#0000ff'})
          })
      });
    }
    map.addLayers(kmlLayers);

    //Add a selector control to the kmllayer with popup functions
    var kmlLayersCtl = new OpenLayers.Control.SelectFeature(kmlLayers, { 
        onSelect: createPopup, 
        onUnselect: destroyPopup,
    });
    map.addControl(kmlLayersCtl);
    kmlLayersCtl.activate();


	            var switcherControl = new OpenLayers.Control.LayerSwitcher();
	            map.addControl(switcherControl);
	            switcherControl.maximizeControl();
	
	            map.zoomToExtent( mapBounds.transform(map.displayProjection, map.projection ) );
			
	            map.addControl(new OpenLayers.Control.PanZoomBar());
	            map.addControl(new OpenLayers.Control.MousePosition());
	            map.addControl(new OpenLayers.Control.KeyboardDefaults());

	        }		

</script>
</head>
<body onload="init()">
<div id="map">
<strong>&nbsp;Could not load local XML</strong>
<ol>
<li>Your browser should support JavaScript and <a href="http://enable-javascript.com/" target="_blank">JavaScript should be enabled</a></li>
<li>If you are using Opera: allow <a href="opera:config#UserPrefs|AllowFileXMLHttpRequest" target="_blank">opera:config#UserPrefs|AllowFileXMLHttpRequest</a></li>
</ol> 
<script type="text/javascript">
document.writeln('<strong>&nbsp;Your browser is:</strong> ' + navigator.userAgent);
</script>
</div>
</body>
</html>